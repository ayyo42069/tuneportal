<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Morse Code Converter</title>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <style>
    /* Existing styles */
    .dot-animation {
      animation: blink 300ms ease-in-out;
    }
    .dash-animation {
      animation: blink 900ms ease-in-out;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    .light {
      transition: background-color 0.2s ease;
    }
    .morse-dot, .morse-dash, .morse-space, .morse-word {
      display: inline-block;
      margin: 0 2px;
    }
    .morse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #3B82F6;
    }
    .morse-dash {
      width: 24px;
      height: 8px;
      border-radius: 4px;
      background-color: #3B82F6;
    }
    .morse-space {
      width: 8px;
    }
    .morse-word {
      width: 16px;
    }
    .history-item {
      transition: all 0.2s ease;
    }
    .history-item:hover {
      background-color: #f3f4f6;
    }
    .audio-wave {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 30px;
    }
    .audio-wave span {
      display: inline-block;
      width: 3px;
      margin: 0 1px;
      background-color: #3B82F6;
      height: 5px;
      animation: audio-wave 1s ease-in-out infinite;
    }
    .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
    .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
    .audio-wave span:nth-child(4) { animation-delay: 0.3s; }
    .audio-wave span:nth-child(5) { animation-delay: 0.4s; }
    .hidden-wave span { animation: none; height: 3px; background-color: #CBD5E1; }
    @keyframes audio-wave {
      0%, 100% { height: 5px; }
      50% { height: 20px; }
    }
    /* New styles */
    .shake {
      animation: shake 0.3s;
    }
    @keyframes shake {
      0% { transform: translate(0px); }
      25% { transform: translate(2px); }
      50% { transform: translate(-2px); }
      75% { transform: translate(2px); }
      100% { transform: translate(0px); }
    }
    /* Progress bar styles */
    #progressBarContainer {
      width: 100%;
      background-color: #e5e7eb;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #3B82F6;
      transition: width 0.1s linear;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col items-center justify-center p-4">

 <div class="w-full max-w-md flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-gray-800">Morse Converter</h1>
  
  </div>
  
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <!-- Mode selection: Encode / Decode -->
    <div class="flex justify-center space-x-4 mb-4">
      <label class="inline-flex items-center">
        <input type="radio" name="mode" value="encode" checked class="form-radio" id="encodeMode">
        <span class="ml-2">Encode</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="mode" value="decode" class="form-radio" id="decodeMode">
        <span class="ml-2">Decode</span>
      </label>
    </div>
    
    <!-- Input section -->
    <div class="mb-4">
      <label for="textInput" class="block text-sm font-medium text-gray-700 mb-1" id="inputLabel">Enter your text:</label>
      <div class="flex">
        <textarea id="textInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
          rows="3" placeholder="Type your message here..." aria-label="Input text"></textarea>
        <button id="clearBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 rounded-r-md border border-l-0 border-gray-300 flex items-center justify-center" 
          title="Clear text" aria-label="Clear text">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Output section -->
      <div class="mb-4">
    <div class="flex justify-between items-center mb-1">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="outputLabel">Morse Code Output:</label>
      <div id="outputButtons" class="flex flex-wrap gap-1">
          <button id="copyBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center" title="Copy to clipboard" aria-label="Copy">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
            </svg>
            Copy
          </button>
          <button id="shareBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center" title="Share" aria-label="Share">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 12v.01M12 4v.01M20 12v.01M12 20v.01" />
            </svg>
            Share
          </button>
          <button id="downloadBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center" title="Download" aria-label="Download">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
            Download
          </button>
          <button id="visualizeBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center" title="Show visual representation" aria-label="Visualize">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Visualize
          </button>
        </div>
      </div>
      <div id="morseOutput" class="w-full min-h-12 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-700 break-all" aria-live="polite"></div>
      <div id="visualOutput" class="w-full mt-2 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md hidden"></div>
    </div>
    
    <!-- Visual and audio indicators -->
    <div class="flex space-x-2 items-center mb-4">
      <div id="visualIndicator" class="h-10 w-10 rounded-full bg-gray-200 light"></div>
      <div id="audioWave" class="flex-1 audio-wave hidden-wave h-10">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
    
    <!-- Progress bar -->
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>
    
    <!-- Feature toggles -->
    <div class="grid grid-cols-2 gap-2 mt-4">
      <div class="flex items-center">
        <input type="checkbox" id="vibrationToggle" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked aria-label="Enable Vibration">
        <label for="vibrationToggle" class="ml-2 block text-sm text-gray-700">Enable Vibration</label>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="visualToggle" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked aria-label="Visual Feedback">
        <label for="visualToggle" class="ml-2 block text-sm text-gray-700">Visual Feedback</label>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="audioToggle" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked aria-label="Audio Feedback">
        <label for="audioToggle" class="ml-2 block text-sm text-gray-700">Audio Feedback</label>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="autoConvertToggle" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" aria-label="Auto Convert">
        <label for="autoConvertToggle" class="ml-2 block text-sm text-gray-700">Auto-Convert</label>
      </div>
    </div>
    
    <!-- Advanced Audio Settings -->
    <div class="mt-4 border-t pt-4">
      <h2 class="text-sm font-medium text-gray-700 mb-2">Advanced Audio Settings</h2>
      <div class="mb-2">
        <label for="frequencyControl" class="block text-xs text-gray-600">Tone Frequency: <span id="frequencyValue">800 Hz</span></label>
        <input type="range" id="frequencyControl" min="400" max="1200" step="50" value="800" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
      </div>
      <div>
        <label for="volumeControl" class="block text-xs text-gray-600">Volume: <span id="volumeValue">0.5</span></label>
        <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
      </div>
    </div>
    
    <!-- Speed control -->
    <div class="mt-4">
      <label for="speedControl" class="block text-sm font-medium text-gray-700 mb-1">Speed:</label>
      <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span>Slow</span>
        <span id="speedValue">Normal (1x)</span>
        <span>Fast</span>
      </div>
    </div>
    
    <!-- History section -->
    <div class="mt-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-sm font-medium text-gray-700">History</h2>
        <div class="flex space-x-2">
          <input type="text" id="historySearch" placeholder="Search history" class="text-xs px-2 py-1 border border-gray-300 rounded" aria-label="Search history">
          <button id="exportHistoryBtn" class="text-xs text-blue-600 hover:text-blue-800">Export</button>
          <button id="clearHistoryBtn" class="text-xs text-red-600 hover:text-red-800">Clear All</button>
        </div>
      </div>
      <div id="historyList" class="max-h-40 overflow-y-auto">
        <div class="text-xs text-gray-500 text-center p-2">No history yet</div>
      </div>
    </div>
    
    <!-- Help/Tutorial Section -->
    <div class="mt-6">
      <details class="text-sm text-gray-600">
        <summary class="cursor-pointer font-medium text-blue-600 hover:text-blue-800">How to use</summary>
        <div class="mt-2 pl-4">
          <ol class="list-decimal">
            <li>Select mode: Encode (text to Morse) or Decode (Morse to text).</li>
            <li>Enter text or Morse code in the input field.</li>
            <li>Click "Convert" to transform the input.</li>
            <li>Use the "Play" button to experience Morse code with audio, visual, and vibration feedback.</li>
            <li>Adjust speed, tone frequency, and volume as desired.</li>
            <li>Click "Visualize" to toggle a graphical representation.</li>
            <li>Conversions are saved in History. You can search, export, or clear history.</li>
            <li>Use the Share and Download buttons to save or share your conversion.</li>
      
          </ol>
          <div class="mt-2 p-2 bg-amber-50 rounded border border-amber-200 text-xs text-amber-700">
            <p><strong>Note:</strong> Vibration is not supported on iOS devices (including Safari). On these devices, please use audio feedback instead.</p>
          </div>
        </div>
      </details>
    </div>
    
    <!-- Control buttons -->
    <div class="flex space-x-2 mt-4">
      <button id="convertBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors" aria-label="Convert">Convert</button>
      <button id="playBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors flex items-center justify-center" disabled aria-label="Play">
        <span id="playText">Play</span>
        <span id="stopText" class="hidden">Stop</span>
      </button>
    </div>
    
    <div id="supportMessage" class="hidden text-sm text-center text-amber-500 mt-2 p-2 bg-amber-50 rounded-md border border-amber-200"></div>
  </div>
  
  <script>
    // Morse code mapping and reverse mapping for decode
    const morseCodeMap = {
      'a': '.-', 'b': '-...', 'c': '-.-.', 'd': '-..', 'e': '.', 'f': '..-.', 'g': '--.', 'h': '....', 
      'i': '..', 'j': '.---', 'k': '-.-', 'l': '.-..', 'm': '--', 'n': '-.', 'o': '---', 'p': '.--.',
      'q': '--.-', 'r': '.-.', 's': '...', 't': '-', 'u': '..-', 'v': '...-', 'w': '.--', 'x': '-..-',
      'y': '-.--', 'z': '--..', '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....',
      '6': '-....', '7': '--...', '8': '---..', '9': '----.', '0': '-----', '.': '.-.-.-', ',': '--..--',
      '?': '..--..', "'": '.----.', '!': '-.-.--', '/': '-..-.', '(': '-.--.', ')': '-.--.-', '&': '.-...',
      ':': '---...', ';': '-.-.-.', '=': '-...-', '+': '.-.-.', '-': '-....-', '_': '..--.-', '"': '.-..-.',
      '$': '...-..-', '@': '.--.-.', ' ': '/'
    };
    const textMap = {};
    for (const key in morseCodeMap) {
      textMap[morseCodeMap[key]] = key;
    }
    
    // DOM elements
    const textInput = document.getElementById('textInput');
    const inputLabel = document.getElementById('inputLabel');
    const morseOutput = document.getElementById('morseOutput');
    const outputLabel = document.getElementById('outputLabel');
    const visualOutput = document.getElementById('visualOutput');
    const convertBtn = document.getElementById('convertBtn');
    const playBtn = document.getElementById('playBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const visualizeBtn = document.getElementById('visualizeBtn');
    const supportMessage = document.getElementById('supportMessage');
    const visualIndicator = document.getElementById('visualIndicator');
    const audioWave = document.getElementById('audioWave');
    const playText = document.getElementById('playText');
    const stopText = document.getElementById('stopText');
    const progressBar = document.getElementById('progressBar');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const historySearch = document.getElementById('historySearch');
    const exportHistoryBtn = document.getElementById('exportHistoryBtn');
    const speedControl = document.getElementById('speedControl');
    const speedValue = document.getElementById('speedValue');
    const frequencyControl = document.getElementById('frequencyControl');
    const frequencyValue = document.getElementById('frequencyValue');
    const volumeControl = document.getElementById('volumeControl');
    const volumeValue = document.getElementById('volumeValue');
    const themeToggle = document.getElementById('themeToggle');
    const encodeMode = document.getElementById('encodeMode');
    const decodeMode = document.getElementById('decodeMode');
    
    // Feature toggles
    const vibrationToggle = document.getElementById('vibrationToggle');
    const visualToggle = document.getElementById('visualToggle');
    const audioToggle = document.getElementById('audioToggle');
    const autoConvertToggle = document.getElementById('autoConvertToggle');
    
    // Audio context and oscillator
    let audioContext;
    let oscillator;
    let isPlaying = false;
    
    // Playback settings
    let playbackSpeed = 1;
    let toneFrequency = parseInt(frequencyControl.value, 10);
    let toneVolume = parseFloat(volumeControl.value);
    
    // Mode ('encode' or 'decode')
    let mode = 'encode';
    
    // History array
    let history = JSON.parse(localStorage.getItem('morseHistory')) || [];
    
    // Initialize the app
    function init() {
      // Check for vibration support
      const hasVibrationSupport = 'navigator' in window && 'vibrate' in navigator;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (!hasVibrationSupport || isIOS) {
        supportMessage.textContent = isIOS 
          ? 'Vibration is not supported on iOS devices. Using audio feedback instead.'
          : 'Vibration is not supported on this device/browser. Using audio feedback instead.';
        supportMessage.classList.remove('hidden');
        vibrationToggle.checked = false;
        vibrationToggle.disabled = true;
        audioToggle.checked = true;
      }
      
      updateHistoryDisplay();
      speedControl.addEventListener('input', updateSpeedDisplay);
      updateSpeedDisplay();
      frequencyControl.addEventListener('input', () => {
        toneFrequency = parseInt(frequencyControl.value, 10);
        frequencyValue.textContent = toneFrequency + ' Hz';
      });
      volumeControl.addEventListener('input', () => {
        toneVolume = parseFloat(volumeControl.value);
        volumeValue.textContent = toneVolume;
      });
      themeToggle.addEventListener('click', toggleTheme);
      encodeMode.addEventListener('change', updateMode);
      decodeMode.addEventListener('change', updateMode);
      historySearch.addEventListener('input', filterHistory);
    }
    
    // Update speed display
    function updateSpeedDisplay() {
      playbackSpeed = parseFloat(speedControl.value);
      let displayText = 'Normal (1x)';
      if (playbackSpeed < 1) {
        displayText = `Slow (${playbackSpeed.toFixed(1)}x)`;
      } else if (playbackSpeed > 1) {
        displayText = `Fast (${playbackSpeed.toFixed(1)}x)`;
      }
      speedValue.textContent = displayText;
    }
    

    
    // Update mode (encode/decode)
    function updateMode() {
      mode = encodeMode.checked ? 'encode' : 'decode';
      inputLabel.textContent = mode === 'encode' ? 'Enter your text:' : 'Enter Morse code:';
      outputLabel.textContent = mode === 'encode' ? 'Morse Code Output:' : 'Text Output:';
      textInput.value = '';
      morseOutput.textContent = '';
    }
    
    // Convert text to Morse code
    function convertToMorse(text) {
      return text.toLowerCase().split('').map(char => morseCodeMap[char] || char).join(' ');
    }
    
    // Decode Morse code to text
    function decodeMorse(morse) {
      return morse.split(' ').map(code => textMap[code] || '').join('');
    }
    
    // Create visual Morse representation
    function createVisualMorse(morseCode) {
      visualOutput.innerHTML = '';
      for (let i = 0; i < morseCode.length; i++) {
        const char = morseCode[i];
        const element = document.createElement('span');
        if (char === '.') element.className = 'morse-dot';
        else if (char === '-') element.className = 'morse-dash';
        else if (char === ' ') element.className = 'morse-space';
        else if (char === '/') element.className = 'morse-word';
        visualOutput.appendChild(element);
      }
    }
    
    // Create vibration pattern from Morse code
    function createVibrationPattern(morseCode) {
      const pattern = [];
      const dotDuration = Math.round(100 / playbackSpeed);
      const dashDuration = Math.round(300 / playbackSpeed);
      const elementGap = Math.round(100 / playbackSpeed);
      const letterGap = Math.round(300 / playbackSpeed);
      const wordGap = Math.round(700 / playbackSpeed);
      for (let i = 0; i < morseCode.length; i++) {
        const char = morseCode[i];
        if (char === '.') {
          pattern.push(dotDuration);
          pattern.push(elementGap);
        } else if (char === '-') {
          pattern.push(dashDuration);
          pattern.push(elementGap);
        } else if (char === ' ') {
          pattern.push(letterGap - elementGap);
        } else if (char === '/') {
          pattern.push(wordGap - elementGap);
        }
      }
      return pattern;
    }
    
    // Initialize audio context
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    
    // Play a tone
    function playTone(frequency, duration) {
      return new Promise((resolve) => {
        if (!audioToggle.checked || !audioContext) {
          resolve();
          return;
        }
        oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = frequency;
        gainNode.gain.value = toneVolume;
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(toneVolume, now + 0.01);
        gainNode.gain.linearRampToValueAtTime(0, now + duration / 1000 - 0.01);
        setTimeout(() => {
          oscillator.stop();
          oscillator.disconnect();
          gainNode.disconnect();
          resolve();
        }, duration);
      });
    }
    
    // Play silence
    function playSilence(duration) {
      return new Promise((resolve) => {
        setTimeout(resolve, duration);
      });
    }
    
    // Visual feedback during playback
    function playVisualMorse(morseCode) {
      return new Promise((resolve) => {
        if (!visualToggle.checked) {
          resolve();
          return;
        }
        const dotDuration = Math.round(300 / playbackSpeed);
        const dashDuration = Math.round(900 / playbackSpeed);
        const elementGap = Math.round(100 / playbackSpeed);
        const letterGap = Math.round(300 / playbackSpeed);
        const wordGap = Math.round(700 / playbackSpeed);
        let timeOffset = 0;
        for (let i = 0; i < morseCode.length; i++) {
          const char = morseCode[i];
          if (char === '.') {
            setTimeout(() => {
              visualIndicator.style.backgroundColor = '#3B82F6';
              visualIndicator.classList.add('dot-animation');
            }, timeOffset);
            setTimeout(() => {
              visualIndicator.style.backgroundColor = '#E5E7EB';
              visualIndicator.classList.remove('dot-animation');
            }, timeOffset + dotDuration);
            timeOffset += dotDuration + elementGap;
          } else if (char === '-') {
            setTimeout(() => {
              visualIndicator.style.backgroundColor = '#3B82F6';
              visualIndicator.classList.add('dash-animation');
            }, timeOffset);
            setTimeout(() => {
              visualIndicator.style.backgroundColor = '#E5E7EB';
              visualIndicator.classList.remove('dash-animation');
            }, timeOffset + dashDuration);
            timeOffset += dashDuration + elementGap;
          } else if (char === ' ') {
            timeOffset += letterGap - elementGap;
          } else if (char === '/') {
            timeOffset += wordGap - elementGap;
          }
        }
        setTimeout(resolve, timeOffset);
      });
    }
    
    // Play audio Morse code
    async function playAudioMorse(morseCode) {
      if (!audioToggle.checked) return;
      const dotDuration = Math.round(100 / playbackSpeed);
      const dashDuration = Math.round(300 / playbackSpeed);
      const elementGap = Math.round(100 / playbackSpeed);
      const letterGap = Math.round(300 / playbackSpeed);
      const wordGap = Math.round(700 / playbackSpeed);
      audioWave.classList.remove('hidden-wave');
      for (let i = 0; i < morseCode.length; i++) {
        if (!isPlaying) break;
        const char = morseCode[i];
        if (char === '.') {
          await playTone(toneFrequency, dotDuration);
          await playSilence(elementGap);
        } else if (char === '-') {
          await playTone(toneFrequency, dashDuration);
          await playSilence(elementGap);
        } else if (char === ' ') {
          await playSilence(letterGap - elementGap);
        } else if (char === '/') {
          await playSilence(wordGap - elementGap);
        }
      }
      audioWave.classList.add('hidden-wave');
    }
    
    // Play vibration or simulate haptic feedback
    function playVibration(pattern) {
      if (navigator.vibrate && vibrationToggle.checked) {
        navigator.vibrate(pattern);
        return true;
      } else {
        visualIndicator.classList.add('shake');
        setTimeout(() => visualIndicator.classList.remove('shake'), 300);
        console.log('Vibration not supported or disabled');
        return false;
      }
    }
    
    // Update progress bar during playback
    function updateProgressBar(duration) {
      progressBar.style.width = '0%';
      let startTime = Date.now();
      const interval = setInterval(() => {
        if (!isPlaying) {
          clearInterval(interval);
          progressBar.style.width = '0%';
          return;
        }
        let elapsed = Date.now() - startTime;
        let percentage = Math.min((elapsed / duration) * 100, 100);
        progressBar.style.width = percentage + '%';
        if (percentage >= 100) clearInterval(interval);
      }, 100);
    }
    
    // Stop playing
    function stopPlaying() {
      isPlaying = false;
      if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
      }
      navigator.vibrate && navigator.vibrate(0);
      visualIndicator.style.backgroundColor = '#E5E7EB';
      visualIndicator.classList.remove('dot-animation', 'dash-animation');
      audioWave.classList.add('hidden-wave');
      playText.classList.remove('hidden');
      stopText.classList.add('hidden');
      convertBtn.disabled = false;
      progressBar.style.width = '0%';
    }
    
    // Add conversion to history
    function addToHistory(input, output) {
      if (input && output && (history.length === 0 || history[0].input !== input)) {
        history.unshift({ input, output, mode, timestamp: new Date().toISOString() });
        if (history.length > 20) history.pop();
        localStorage.setItem('morseHistory', JSON.stringify(history));
        updateHistoryDisplay();
      }
    }
    
    // Update history display with search filtering
    function updateHistoryDisplay() {
      const query = historySearch.value.toLowerCase();
      historyList.innerHTML = '';
      const filteredHistory = history.filter(item =>
        item.input.toLowerCase().includes(query) || item.output.toLowerCase().includes(query)
      );
      if (filteredHistory.length === 0) {
        historyList.innerHTML = '<div class="text-xs text-gray-500 text-center p-2">No history found</div>';
        return;
      }
      filteredHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item text-xs p-2 border-b border-gray-100 cursor-pointer';
        const date = new Date(item.timestamp);
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        historyItem.innerHTML = `
          <div class="flex justify-between">
            <div class="font-medium truncate" title="${item.input}">${item.input}</div>
            <div class="text-gray-500">${formattedTime}</div>
          </div>
          <div class="text-gray-600 truncate" title="${item.output}">${item.output}</div>
          <div class="text-gray-400 text-xs">${item.mode === 'encode' ? 'Encoded' : 'Decoded'}</div>
        `;
        historyItem.addEventListener('click', () => {
          textInput.value = item.input;
          convertText();
        });
        historyList.appendChild(historyItem);
      });
    }
    
    // Filter history based on search input
    function filterHistory() {
      updateHistoryDisplay();
    }
    
    // Export history as a text file
    function exportHistory() {
      const dataStr = JSON.stringify(history, null, 2);
      const blob = new Blob([dataStr], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'morse_history.txt';
      a.click();
      window.URL.revokeObjectURL(url);
    }
    
    // Convert input (encode or decode) and update UI
    function convertText() {
      const text = textInput.value.trim();
      if (text) {
        let output = mode === 'encode' ? convertToMorse(text) : decodeMorse(text);
        morseOutput.textContent = output;
        playBtn.disabled = false;
        addToHistory(text, output);
        return output;
      } else {
        morseOutput.textContent = '';
        visualOutput.innerHTML = '';
        visualOutput.classList.add('hidden');
        playBtn.disabled = true;
        return '';
      }
    }
    
    // Event listeners
    convertBtn.addEventListener('click', convertText);
    clearBtn.addEventListener('click', () => {
      textInput.value = '';
      morseOutput.textContent = '';
      visualOutput.innerHTML = '';
      visualOutput.classList.add('hidden');
      playBtn.disabled = true;
    });
    copyBtn.addEventListener('click', () => {
      const output = morseOutput.textContent;
      if (output) {
        navigator.clipboard.writeText(output).then(() => {
          const originalText = copyBtn.innerHTML;
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Copied!';
          copyBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          copyBtn.classList.add('bg-green-200', 'text-green-700');
          setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            copyBtn.classList.remove('bg-green-200', 'text-green-700');
          }, 2000);
        });
      }
    });
    shareBtn.addEventListener('click', () => {
      const output = morseOutput.textContent;
      if (navigator.share && output) {
        navigator.share({ title: 'Morse Code Conversion', text: output }).catch(console.error);
      } else {
        alert('Share API not supported or no content to share.');
      }
    });
    downloadBtn.addEventListener('click', () => {
      const output = morseOutput.textContent;
      if (output) {
        const blob = new Blob([output], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'morse_output.txt';
        a.click();
        window.URL.revokeObjectURL(url);
      }
    });
    visualizeBtn.addEventListener('click', () => {
      const output = morseOutput.textContent;
      if (output) {
        createVisualMorse(output);
        visualOutput.classList.toggle('hidden');
        visualizeBtn.innerHTML = visualOutput.classList.contains('hidden')
          ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Hide'
          : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Visualize';
      }
    });
    playBtn.addEventListener('click', async () => {
      if (!isPlaying) {
        isPlaying = true;
        playText.classList.add('hidden');
        stopText.classList.remove('hidden');
        convertBtn.disabled = true;
        initAudio();
        const output = morseOutput.textContent;
        if (output) {
          const vibrationPattern = createVibrationPattern(output);
          playVibration(vibrationPattern);
          // Calculate total duration for progress bar
          let totalDuration = 0;
          const dotDuration = Math.round(100 / playbackSpeed);
          const dashDuration = Math.round(300 / playbackSpeed);
          const elementGap = Math.round(100 / playbackSpeed);
          const letterGap = Math.round(300 / playbackSpeed);
          const wordGap = Math.round(700 / playbackSpeed);
          for (let i = 0; i < output.length; i++) {
            const char = output[i];
            if (char === '.') totalDuration += dotDuration + elementGap;
            else if (char === '-') totalDuration += dashDuration + elementGap;
            else if (char === ' ') totalDuration += letterGap - elementGap;
            else if (char === '/') totalDuration += wordGap - elementGap;
          }
          updateProgressBar(totalDuration);
          await Promise.all([
            playAudioMorse(output),
            playVisualMorse(output)
          ]);
        }
        stopPlaying();
      } else {
        stopPlaying();
      }
    });
    textInput.addEventListener('input', () => {
      if (autoConvertToggle.checked) convertText();
    });
    clearHistoryBtn.addEventListener('click', () => {
      history = [];
      localStorage.removeItem('morseHistory');
      updateHistoryDisplay();
    });
    exportHistoryBtn.addEventListener('click', exportHistory);
    
    // Register service worker for offline functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
    
    // Initialize app on load
    init();
  </script>
</body>
</html>
